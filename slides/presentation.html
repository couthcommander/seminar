<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>The R Seminar</title>
    <!-- Styles -->
    
    <link rel="stylesheet" media="print" href="file:///usr/local/lib/python2.7/dist-packages/landslide/themes/default/css/print.css">
    <link rel="stylesheet" media="screen, projection" href="file:///usr/local/lib/python2.7/dist-packages/landslide/themes/default/css/screen.css">
    
    
    <!-- /Styles -->
    <!-- Javascripts -->
    
    <script type="text/javascript" src="file:///usr/local/lib/python2.7/dist-packages/landslide/themes/default/js/slides.js"></script>
    
    
    <!-- /Javascripts -->
</head>
<body>
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>The R Seminar</h1></header>
            
            
            <section><h1>You Wish You'd Had Ten Years Ago</h1>
<p><a href="https://github.com/couthcommander/seminar">GitHub: R Seminar</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              1/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Code Efficiency</h2></header>
            
            
            <section><ol>
<li>How long does it take to write?</li>
<li>How long does it take to modify?</li>
<li>How long does it take to run?</li>
</ol>
<p>This talk is specifically tailored to the R programming language, but you could certainly extend the principles to other languages.</p>
<ul>
<li>It's a good thing if other people can read and understand your code<ul>
<li>It's even better if you can understand your code when you revisit it three years later</li>
</ul>
</li>
<li>It's a good thing if your code runs start to finish without intervention<ul>
<li>It's even better if you can specify at what point to start or finish</li>
</ul>
</li>
<li>It's a good thing if you can optimize code so that it runs in 1 minute instead of 10 minutes<ul>
<li>It's even better if you didn't spend 4 hours (pre-optimization)</li>
</ul>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              2/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Key Concepts</h2></header>
            
            
            <section><ol>
<li>Don't repeat yourself - don't copy and paste</li>
<li>Use modular design - keep it simple or comment</li>
<li>Learn to vectorize and predefine the length of vectors</li>
</ol>
<p>Inspiration for this talk came from examining an R script used for data validation.
This is fairly normal task, and it provided several examples of things worth thinking about when writing such a script.
The data sets provided were simulated (and probably aren't very realistic).</p>
<p>In a perfect world, this data would be accompanied by a data dictionary or meta-data that would perform the validation.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              3/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Starting Point</h2></header>
            
            
            <section><p>Before validating your data, transform your data.
This may including adding, editing, or removing columns, as well as merging multiple data sets.
Most transformation operations can be vectorized.</p>
<p>Transformations should create intermediate data sets.</p>
<ol>
<li>These can be saved in compressed formats</li>
<li>These provide checkpoints that can be utilized instead of re-running entire scripts</li>
</ol></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              4/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>Assign a new column</h2></header>
            
            
            <section><div class="highlight"><pre><span class="lineno"> 1</span> x <span class="o">&lt;-</span> data.frame<span class="p">(</span>id<span class="o">=</span>seq<span class="p">(</span><span class="m">1000000</span><span class="p">))</span>
<span class="lineno"> 2</span> s <span class="o">&lt;-</span> sample<span class="p">(</span>nrow<span class="p">(</span>x<span class="p">))</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="c1"># dollar sign</span>
<span class="lineno"> 5</span> x<span class="o">$</span>s1 <span class="o">&lt;-</span> s
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="c1"># single bracket with comma</span>
<span class="lineno"> 8</span> x<span class="p">[,</span><span class="s">&#39;s2&#39;</span><span class="p">]</span> <span class="o">&lt;-</span> s
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="c1"># single bracket</span>
<span class="lineno">11</span> x<span class="p">[</span><span class="s">&#39;s3&#39;</span><span class="p">]</span> <span class="o">&lt;-</span> s
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="c1"># double bracket</span>
<span class="lineno">14</span> x<span class="p">[[</span><span class="s">&#39;s4&#39;</span><span class="p">]]</span> <span class="o">&lt;-</span> s
<span class="lineno">15</span> 
<span class="lineno">16</span> <span class="c1"># assign default (NA), then value</span>
<span class="lineno">17</span> x<span class="o">$</span>s <span class="o">&lt;-</span> <span class="kc">NA</span>
<span class="lineno">18</span> x<span class="o">$</span>s <span class="o">&lt;-</span> s
</pre></div>

<h3>read more</h3>
<div class="highlight"><pre><span class="lineno">1</span> <span class="o">?</span>Extract
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              5/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>Convert TRUE/FALSE to 1/0</h2></header>
            
            
            <section><div class="highlight"><pre><span class="lineno">1</span> x <span class="o">&lt;-</span> sample<span class="p">(</span><span class="kc">TRUE</span><span class="o">:</span><span class="kc">FALSE</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> replace<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="lineno">2</span> as.numeric<span class="p">(</span>x<span class="p">)</span>
<span class="lineno">3</span> x<span class="m">+0</span>
<span class="lineno">4</span> x<span class="o">*</span><span class="m">1</span>
<span class="lineno">5</span> mode<span class="p">(</span>x<span class="p">)</span> <span class="o">&lt;-</span> <span class="s">&#39;numeric&#39;</span>
</pre></div>

<p>Some optimizations just don't matter.</p>
<p>It's good to know there's more than one way to do it.</p>
<p>Choose your preference weighing how easy it is to type or read -- then be consistent.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              6/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>Converting strings to dates</h2></header>
            
            
            <section><div class="highlight"><pre><span class="lineno"> 1</span> <span class="c1"># This violates **don&#39;t repeat yourself**</span>
<span class="lineno"> 2</span> dat<span class="o">$</span>enroll.date <span class="o">&lt;-</span> as.Date<span class="p">(</span>dat<span class="o">$</span>enroll.date<span class="p">,</span> format <span class="o">=</span> <span class="s">&#39;%Y-%m-%d&#39;</span><span class="p">)</span>
<span class="lineno"> 3</span> dat<span class="o">$</span>surgery.date <span class="o">&lt;-</span> as.Date<span class="p">(</span>dat<span class="o">$</span>surgery.date<span class="p">,</span> format <span class="o">=</span> <span class="s">&#39;%Y-%m-%d&#39;</span><span class="p">)</span>
<span class="lineno"> 4</span> dat<span class="o">$</span>followup.date <span class="o">&lt;-</span> as.Date<span class="p">(</span>dat<span class="o">$</span>followup.date<span class="p">,</span> format <span class="o">=</span> <span class="s">&#39;%Y-%m-%d&#39;</span><span class="p">)</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="c1"># name date columns</span>
<span class="lineno"> 7</span> date.vars <span class="o">&lt;-</span> c<span class="p">(</span><span class="s">&#39;enroll.date&#39;</span><span class="p">,</span> <span class="s">&#39;surgery.date&#39;</span><span class="p">,</span> <span class="s">&#39;followup.date&#39;</span><span class="p">)</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c1"># Hmisc::Cs doesn&#39;t require quotes</span>
<span class="lineno">10</span> date.vars <span class="o">&lt;-</span> Cs<span class="p">(</span>enroll.date<span class="p">,</span> surgery.date<span class="p">,</span> followup.date<span class="p">)</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="c1"># rely on good column names</span>
<span class="lineno">13</span> date.vars <span class="o">&lt;-</span> grep<span class="p">(</span><span class="s">&#39;date$&#39;</span><span class="p">,</span> names<span class="p">(</span>dat<span class="p">),</span> value<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="lineno">14</span> 
<span class="lineno">15</span> <span class="c1"># loop over date variables</span>
<span class="lineno">16</span> <span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> date.vars<span class="p">)</span> <span class="p">{</span>
<span class="lineno">17</span>   dat<span class="p">[,</span>i<span class="p">]</span> <span class="o">&lt;-</span> as.Date<span class="p">(</span>dat<span class="p">[,</span>i<span class="p">],</span> format <span class="o">=</span> <span class="s">&#39;%Y-%m-%d&#39;</span><span class="p">)</span>
<span class="lineno">18</span> <span class="p">}</span>
<span class="lineno">19</span> 
<span class="lineno">20</span> <span class="c1"># lapply works</span>
<span class="lineno">21</span> dat<span class="p">[,</span>date.vars<span class="p">]</span> <span class="o">&lt;-</span> 
<span class="lineno">22</span>   lapply<span class="p">(</span>dat<span class="p">[,</span>date.vars<span class="p">],</span> as.Date<span class="p">,</span> format <span class="o">=</span> <span class="s">&#39;%Y-%m-%d&#39;</span><span class="p">)</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              7/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>Converting strings to date-times</h2></header>
            
            
            <section><h3>Specify the timezone -- default relies on locale so results may vary on user/computer/location</h3>
<h3>UTC will avoid daylight savings problems</h3>
<div class="highlight"><pre><span class="lineno">1</span> time.vars <span class="o">&lt;-</span> grep<span class="p">(</span><span class="s">&#39;time$&#39;</span><span class="p">,</span> names<span class="p">(</span>hosp<span class="p">),</span> value<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="lineno">2</span> <span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> time.vars<span class="p">)</span> <span class="p">{</span>
<span class="lineno">3</span>   hosp<span class="p">[,</span>i<span class="p">]</span> <span class="o">&lt;-</span>
<span class="lineno">4</span>     as.POSIXct<span class="p">(</span>hosp<span class="p">[,</span>i<span class="p">],</span> format <span class="o">=</span> <span class="s">&#39;%Y-%m-%d %H:%M&#39;</span><span class="p">,</span> tz <span class="o">=</span> <span class="s">&#39;UTC&#39;</span><span class="p">)</span>
<span class="lineno">5</span> <span class="p">}</span>
</pre></div>

<h3>Consider using function if called from multiple locations in code</h3>
<div class="highlight"><pre><span class="lineno">1</span> dtCT <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">,</span> format <span class="o">=</span> <span class="s">&#39;%Y-%m-%d %H:%M&#39;</span><span class="p">,</span> tz <span class="o">=</span> <span class="s">&#39;UTC&#39;</span><span class="p">,</span> <span class="kc">...</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">2</span>   as.POSIXct<span class="p">(</span>x<span class="p">,</span> format <span class="o">=</span> format<span class="p">,</span> tz <span class="o">=</span> tz<span class="p">,</span> <span class="kc">...</span><span class="p">)</span>
<span class="lineno">3</span> <span class="p">}</span>
<span class="lineno">4</span> hosp<span class="p">[,</span>time.vars<span class="p">]</span> <span class="o">&lt;-</span> lapply<span class="p">(</span>hosp<span class="p">[,</span>time.vars<span class="p">],</span> dtCT<span class="p">)</span>
</pre></div>

<h3>Check out <a href="https://github.com/hadley/lubridate">lubridate</a></h3></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              8/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>Too many tests</h2></header>
            
            
            <section><h3>When is an ifelse statement too long and what are alternatives?</h3>
<div class="highlight"><pre><span class="lineno"> 1</span> age.grp <span class="o">&lt;-</span> ifelse<span class="p">(</span>dat<span class="o">$</span>age <span class="o">&lt;</span> <span class="m">46</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span>
<span class="lineno"> 2</span>   ifelse<span class="p">(</span>dat<span class="o">$</span>age <span class="o">&lt;</span> <span class="m">51</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span>
<span class="lineno"> 3</span>     ifelse<span class="p">(</span>dat<span class="o">$</span>age <span class="o">&lt;</span> <span class="m">56</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span>
<span class="lineno"> 4</span>       ifelse<span class="p">(</span>dat<span class="o">$</span>age <span class="o">&lt;</span> <span class="m">61</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>
<span class="lineno"> 5</span>     <span class="p">)</span>
<span class="lineno"> 6</span>   <span class="p">)</span>
<span class="lineno"> 7</span> <span class="p">)</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c1"># solve arithmetically</span>
<span class="lineno">10</span> age.grp2 <span class="o">&lt;-</span> floor<span class="p">((</span>dat<span class="o">$</span>age<span class="m">-36</span><span class="p">)</span><span class="o">/</span><span class="m">5</span><span class="p">)</span>
<span class="lineno">11</span> <span class="c1"># almost worked, convert 0s to 1s</span>
<span class="lineno">12</span> age.grp2<span class="p">[</span>age.grp2 <span class="o">==</span> <span class="m">0</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="m">1</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="c1"># specify break-points with cut - good for creating factors</span>
<span class="lineno">15</span> age.grp3 <span class="o">&lt;-</span> cut<span class="p">(</span>dat<span class="o">$</span>age<span class="p">,</span> breaks <span class="o">=</span> c<span class="p">(</span><span class="m">40</span><span class="p">,</span> <span class="m">46</span><span class="p">,</span> <span class="m">51</span><span class="p">,</span> <span class="m">56</span><span class="p">,</span> <span class="m">61</span><span class="p">,</span> <span class="m">66</span><span class="p">),</span>
<span class="lineno">16</span>   labels <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> right <span class="o">=</span> <span class="kc">FALSE</span>
<span class="lineno">17</span> <span class="p">)</span>
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="c1"># just want integer result, use findInterval</span>
<span class="lineno">20</span> dat<span class="o">$</span>age.grp <span class="o">&lt;-</span> findInterval<span class="p">(</span>dat<span class="o">$</span>age<span class="p">,</span> c<span class="p">(</span><span class="m">46</span><span class="p">,</span> <span class="m">51</span><span class="p">,</span> <span class="m">56</span><span class="p">,</span> <span class="m">61</span><span class="p">))</span> <span class="o">+</span> <span class="m">1</span>
<span class="lineno">21</span> <span class="c1"># or seq(46, 61, by=5)</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              9/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>What about more complicated tests?</h2></header>
            
            
            <section><div class="highlight"><pre><span class="lineno"> 1</span> r <span class="o">&lt;-</span> numeric<span class="p">(</span>nrow<span class="p">(</span>dat<span class="p">))</span>
<span class="lineno"> 2</span> <span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> seq_along<span class="p">(</span>r<span class="p">))</span> <span class="p">{</span>
<span class="lineno"> 3</span>   tot <span class="o">&lt;-</span> sum<span class="p">(</span>dat<span class="p">[</span>i<span class="p">,</span> c<span class="p">(</span><span class="s">&#39;prev.surg&#39;</span><span class="p">,</span> <span class="s">&#39;diabetes&#39;</span><span class="p">,</span> <span class="s">&#39;obese&#39;</span><span class="p">)])</span>
<span class="lineno"> 4</span>   e <span class="o">&lt;-</span> dat<span class="p">[</span>i<span class="p">,</span> <span class="s">&#39;exercise&#39;</span><span class="p">]</span>
<span class="lineno"> 5</span>   <span class="c1"># this is the worst</span>
<span class="lineno"> 6</span>   <span class="kr">if</span><span class="p">(</span>e <span class="o">==</span> <span class="s">&#39;None&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 7</span>     <span class="kr">if</span><span class="p">(</span>dat<span class="o">$</span>prev.surg<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> dat<span class="o">$</span>diabetes<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> dat<span class="o">$</span>obese<span class="p">[</span>i<span class="p">])</span> <span class="p">{</span>
<span class="lineno"> 8</span>       r<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> <span class="m">10</span>
<span class="lineno"> 9</span>     <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span><span class="p">((</span><span class="o">!</span>dat<span class="o">$</span>prev.surg<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> dat<span class="o">$</span>diabetes<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> dat<span class="o">$</span>obese<span class="p">[</span>i<span class="p">])</span>
<span class="lineno">10</span>       <span class="o">||</span> <span class="p">(</span>dat<span class="o">$</span>prev.surg<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span>dat<span class="o">$</span>diabetes<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> dat<span class="o">$</span>obese<span class="p">[</span>i<span class="p">])</span>
<span class="lineno">11</span>       <span class="o">||</span> <span class="p">(</span>dat<span class="o">$</span>prev.surg<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> dat<span class="o">$</span>diabetes<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span>dat<span class="o">$</span>obese<span class="p">[</span>i<span class="p">]))</span> <span class="p">{</span>
<span class="lineno">12</span>         r<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> <span class="m">9</span>
<span class="lineno">13</span>     <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span><span class="p">((</span><span class="o">!</span>dat<span class="o">$</span>prev.surg<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span>dat<span class="o">$</span>diabetes<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> dat<span class="o">$</span>obese<span class="p">[</span>i<span class="p">])</span>
<span class="lineno">14</span>       <span class="o">||</span> <span class="p">(</span><span class="o">!</span>dat<span class="o">$</span>prev.surg<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> dat<span class="o">$</span>diabetes<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span>dat<span class="o">$</span>obese<span class="p">[</span>i<span class="p">])</span>
<span class="lineno">15</span>       <span class="o">||</span> <span class="p">(</span>dat<span class="o">$</span>prev.surg<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span>dat<span class="o">$</span>diabetes<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span>dat<span class="o">$</span>obese<span class="p">[</span>i<span class="p">]))</span> <span class="p">{</span>
<span class="lineno">16</span>         r<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> <span class="m">8</span>
<span class="lineno">17</span>     <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
<span class="lineno">18</span>       r<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> <span class="m">5</span>
<span class="lineno">19</span>     <span class="p">}</span>
<span class="lineno">20</span>   <span class="c1"># better</span>
<span class="lineno">21</span>   <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span><span class="p">(</span>e <span class="o">==</span> <span class="s">&#39;Some&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">22</span>     <span class="kr">if</span><span class="p">(</span>tot <span class="o">==</span> <span class="m">3</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">23</span>       r<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> <span class="m">9</span>
<span class="lineno">24</span>     <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span><span class="p">(</span>tot <span class="o">==</span> <span class="m">2</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">25</span>       r<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> <span class="m">7</span>
<span class="lineno">26</span>     <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span><span class="p">(</span>tot <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">27</span>       r<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> <span class="m">5</span>
<span class="lineno">28</span>     <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
<span class="lineno">29</span>       r<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> <span class="m">3</span>
<span class="lineno">30</span>     <span class="p">}</span>
<span class="lineno">31</span>   <span class="c1"># reasonable</span>
<span class="lineno">32</span>   <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span><span class="p">(</span>e <span class="o">==</span> <span class="s">&#39;Moderate&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">33</span>     r<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> ifelse<span class="p">(</span>tot <span class="o">==</span> <span class="m">3</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span>
<span class="lineno">34</span>       ifelse<span class="p">(</span>tot <span class="o">==</span> <span class="m">2</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span>
<span class="lineno">35</span>         ifelse<span class="p">(</span>tot <span class="o">==</span> <span class="m">1</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
<span class="lineno">36</span>       <span class="p">)</span>
<span class="lineno">37</span>     <span class="p">)</span>
<span class="lineno">38</span>   <span class="c1"># less intuitive, but less code</span>
<span class="lineno">39</span>   <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span><span class="p">(</span>e <span class="o">==</span> <span class="s">&#39;Lots&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">40</span>     r<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;-</span> c<span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">7</span><span class="p">)[</span>match<span class="p">(</span>tot<span class="p">,</span> <span class="m">0</span><span class="o">:</span><span class="m">3</span><span class="p">)]</span>
<span class="lineno">41</span>   <span class="p">}</span>
<span class="lineno">42</span> <span class="p">}</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              10/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>Vectorized solution is best</h2></header>
            
            
            <section><div class="highlight"><pre><span class="lineno"> 1</span> tots <span class="o">&lt;-</span> rowSums<span class="p">(</span>dat<span class="p">[,</span> c<span class="p">(</span><span class="s">&#39;prev.surg&#39;</span><span class="p">,</span> <span class="s">&#39;diabetes&#39;</span><span class="p">,</span> <span class="s">&#39;obese&#39;</span><span class="p">)])</span>
<span class="lineno"> 2</span> dat<span class="o">$</span>risk <span class="o">&lt;-</span> ifelse<span class="p">(</span>dat<span class="o">$</span>exercise <span class="o">==</span> <span class="s">&#39;None&#39;</span><span class="p">,</span>
<span class="lineno"> 3</span>   ifelse<span class="p">(</span>tots <span class="o">==</span> <span class="m">3</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span>
<span class="lineno"> 4</span>     ifelse<span class="p">(</span>tots <span class="o">==</span> <span class="m">2</span><span class="p">,</span> <span class="m">9</span><span class="p">,</span>
<span class="lineno"> 5</span>       ifelse<span class="p">(</span>tots <span class="o">==</span> <span class="m">1</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>
<span class="lineno"> 6</span>     <span class="p">)</span>
<span class="lineno"> 7</span>   <span class="p">),</span>
<span class="lineno"> 8</span>   ifelse<span class="p">(</span>dat<span class="o">$</span>exercise <span class="o">==</span> <span class="s">&#39;Some&#39;</span><span class="p">,</span>
<span class="lineno"> 9</span>     ifelse<span class="p">(</span>tots <span class="o">==</span> <span class="m">3</span><span class="p">,</span> <span class="m">9</span><span class="p">,</span>
<span class="lineno">10</span>       ifelse<span class="p">(</span>tots <span class="o">==</span> <span class="m">2</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span>
<span class="lineno">11</span>         ifelse<span class="p">(</span>tots <span class="o">==</span> <span class="m">1</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
<span class="lineno">12</span>       <span class="p">)</span>
<span class="lineno">13</span>     <span class="p">),</span>
<span class="lineno">14</span>     ifelse<span class="p">(</span>dat<span class="o">$</span>exercise <span class="o">==</span> <span class="s">&#39;Moderate&#39;</span><span class="p">,</span> c<span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">6</span><span class="p">,</span><span class="m">8</span><span class="p">)[</span>match<span class="p">(</span>tots<span class="p">,</span> <span class="m">0</span><span class="o">:</span><span class="m">3</span><span class="p">)],</span>
<span class="lineno">15</span>       c<span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">7</span><span class="p">)[</span>match<span class="p">(</span>tots<span class="p">,</span> <span class="m">0</span><span class="o">:</span><span class="m">3</span><span class="p">)]</span>
<span class="lineno">16</span>     <span class="p">)</span>
<span class="lineno">17</span>   <span class="p">)</span>
<span class="lineno">18</span> <span class="p">)</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              11/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>Merging datasets</h2></header>
            
            
            <section><h3>Merge on single value</h3>
<div class="highlight"><pre><span class="lineno">1</span> alldat <span class="o">&lt;-</span> merge<span class="p">(</span>dat<span class="p">,</span> hosp<span class="p">)</span>
<span class="lineno">2</span> alldat <span class="o">&lt;-</span> cbind<span class="p">(</span>dat<span class="p">[</span>match<span class="p">(</span>hosp<span class="o">$</span>id<span class="p">,</span> dat<span class="o">$</span>id<span class="p">),],</span>
<span class="lineno">3</span>   hosp<span class="p">[,</span><span class="o">-</span>match<span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> names<span class="p">(</span>hosp<span class="p">))]</span>
<span class="lineno">4</span> <span class="p">)</span>
</pre></div>

<h3>Merge on multiple values</h3>
<div class="highlight"><pre><span class="lineno"> 1</span> dat<span class="o">$</span>key <span class="o">&lt;-</span> sample<span class="p">(</span>LETTERS<span class="p">,</span> nrow<span class="p">(</span>dat<span class="p">),</span> replace <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="lineno"> 2</span> hosp<span class="o">$</span>key <span class="o">&lt;-</span> sample<span class="p">(</span>LETTERS<span class="p">,</span> nrow<span class="p">(</span>hosp<span class="p">),</span> replace <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> alldat <span class="o">&lt;-</span> merge<span class="p">(</span>dat<span class="p">,</span> hosp<span class="p">)</span>
<span class="lineno"> 5</span> dkey <span class="o">&lt;-</span> with<span class="p">(</span>dat<span class="p">,</span> paste<span class="p">(</span>id<span class="p">,</span> key<span class="p">,</span> sep <span class="o">=</span> <span class="s">&#39;|&#39;</span><span class="p">))</span>
<span class="lineno"> 6</span> hkey <span class="o">&lt;-</span> with<span class="p">(</span>hosp<span class="p">,</span> paste<span class="p">(</span>id<span class="p">,</span> key<span class="p">,</span> sep <span class="o">=</span> <span class="s">&#39;|&#39;</span><span class="p">))</span>
<span class="lineno"> 7</span> alldat <span class="o">&lt;-</span> cbind<span class="p">(</span>dat<span class="p">[</span>match<span class="p">(</span>hkey<span class="p">,</span> dkey<span class="p">),],</span>
<span class="lineno"> 8</span>   hosp<span class="p">[,</span><span class="o">-</span>match<span class="p">(</span>c<span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span><span class="s">&#39;key&#39;</span><span class="p">),</span> names<span class="p">(</span>hosp<span class="p">))]</span>
<span class="lineno"> 9</span> <span class="p">)</span>
<span class="lineno">10</span> alldat <span class="o">&lt;-</span> alldat<span class="p">[</span><span class="o">!</span>is.na<span class="p">(</span>alldat<span class="o">$</span>id<span class="p">),]</span>
</pre></div>

<h3>A custom merge using match can be much faster</h3></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              12/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>Intermediate data set</h2></header>
            
            
            <section><h3>Convenient starting point and compressed</h3>
<div class="highlight"><pre><span class="lineno">1</span> <span class="c1"># platform-independent path to working directory</span>
<span class="lineno">2</span> work.dir <span class="o">&lt;-</span> file.path<span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">,</span><span class="s">&#39;to&#39;</span><span class="p">,</span><span class="s">&#39;your&#39;</span><span class="p">,</span><span class="s">&#39;data&#39;</span><span class="p">)</span>
<span class="lineno">3</span> 
<span class="lineno">4</span> <span class="c1"># save for later</span>
<span class="lineno">5</span> save<span class="p">(</span>dat<span class="p">,</span> hosp<span class="p">,</span> alldat<span class="p">,</span> file <span class="o">=</span> file.path<span class="p">(</span>work.dir<span class="p">,</span> <span class="s">&#39;demo_data.RData&#39;</span><span class="p">))</span>
<span class="lineno">6</span> 
<span class="lineno">7</span> <span class="c1"># pick up where you left off</span>
<span class="lineno">8</span> load<span class="p">(</span>file.path<span class="p">(</span>work.dir<span class="p">,</span> <span class="s">&#39;demo_data.RData&#39;</span><span class="p">))</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              13/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h2>Validation</h2></header>
            
            
            <section><ul>
<li>Modularity - write functions for different form validations</li>
<li>Shorter functions are easier to maintain and test</li>
</ul>
<h3>Goal</h3>
<ul>
<li>Generate text file with errors by creating a vector of character strings</li>
</ul>
<h3>Examine by ID or all IDs</h3>
<ul>
<li>Does information in one row inform another?</li>
<li>Determine tasks that can be vectorized</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              14/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>How not to validate</h2></header>
            
            
            <section><div class="highlight"><pre><span class="lineno"> 1</span> errors <span class="o">&lt;-</span> character<span class="p">()</span>
<span class="lineno"> 2</span> errors <span class="o">&lt;-</span> <span class="kc">NULL</span>
<span class="lineno"> 3</span> <span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> seq<span class="p">(</span>nrow<span class="p">(</span>x<span class="p">)))</span> <span class="p">{</span>
<span class="lineno"> 4</span>   <span class="kr">if</span><span class="p">(</span>is.na<span class="p">(</span>x<span class="o">$</span>enroll.date<span class="p">[</span>i<span class="p">]))</span>
<span class="lineno"> 5</span>     errors <span class="o">&lt;-</span> c<span class="p">(</span>errors<span class="p">,</span> <span class="s">&#39;no enroll date&#39;</span><span class="p">)</span>
<span class="lineno"> 6</span>   <span class="kr">if</span><span class="p">(</span>is.na<span class="p">(</span>x<span class="o">$</span>surgery.date<span class="p">[</span>i<span class="p">]))</span>
<span class="lineno"> 7</span>     errors <span class="o">&lt;-</span> c<span class="p">(</span>errors<span class="p">,</span> <span class="s">&#39;no surgery date&#39;</span><span class="p">)</span>
<span class="lineno"> 8</span>   <span class="kr">if</span><span class="p">(</span>is.na<span class="p">(</span>x<span class="o">$</span>followup.date<span class="p">[</span>i<span class="p">]))</span>
<span class="lineno"> 9</span>     errors <span class="o">&lt;-</span> c<span class="p">(</span>errors<span class="p">,</span> <span class="s">&#39;no followup date&#39;</span><span class="p">)</span>
<span class="lineno">10</span>   <span class="kr">if</span><span class="p">(</span>x<span class="o">$</span>enroll.date<span class="p">[</span>i<span class="p">]</span> <span class="o">&gt;</span> x<span class="o">$</span>surgery.date<span class="p">[</span>i<span class="p">])</span>
<span class="lineno">11</span>     errors <span class="o">&lt;-</span> c<span class="p">(</span>errors<span class="p">,</span> <span class="s">&#39;must be enrolled before surgery&#39;</span><span class="p">)</span>
<span class="lineno">12</span>   <span class="kr">if</span><span class="p">(</span>x<span class="o">$</span>surgery.date<span class="p">[</span>i<span class="p">]</span> <span class="o">&gt;</span> x<span class="o">$</span>followup.date<span class="p">[</span>i<span class="p">])</span>
<span class="lineno">13</span>     errors <span class="o">&lt;-</span> c<span class="p">(</span>errors<span class="p">,</span> <span class="s">&#39;must have surgery before follow-up&#39;</span><span class="p">)</span>
<span class="lineno">14</span>   <span class="kr">if</span><span class="p">(</span>x<span class="o">$</span>height<span class="p">[</span>i<span class="p">]</span> <span class="o">&lt;</span> <span class="m">48</span> <span class="o">||</span> x<span class="o">$</span>height<span class="p">[</span>i<span class="p">]</span> <span class="o">&gt;</span> <span class="m">84</span><span class="p">)</span>
<span class="lineno">15</span>     errors <span class="o">&lt;-</span> c<span class="p">(</span>errors<span class="p">,</span> <span class="s">&#39;height is too short or tall&#39;</span><span class="p">)</span>
<span class="lineno">16</span>   <span class="kr">if</span><span class="p">(</span>x<span class="o">$</span>on.insulin<span class="p">[</span>i<span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span>x<span class="o">$</span>diabetes<span class="p">[</span>i<span class="p">])</span>
<span class="lineno">17</span>     errors <span class="o">&lt;-</span> c<span class="p">(</span>errors<span class="p">,</span> <span class="s">&#39;on insulin, but not diabetic&#39;</span><span class="p">)</span>
<span class="lineno">18</span> <span class="p">}</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              15/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>Pre-define errors</h2></header>
            
            
            <section><div class="highlight"><pre><span class="lineno"> 1</span> errors <span class="o">&lt;-</span> character<span class="p">(</span><span class="m">7</span><span class="p">)</span>
<span class="lineno"> 2</span> <span class="c1"># ?sprintf</span>
<span class="lineno"> 3</span> <span class="c1"># use %s for variable place-holder</span>
<span class="lineno"> 4</span> errors<span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">&lt;-</span> sprintf<span class="p">(</span><span class="s">&quot;no enroll date for rows [%s]&quot;</span><span class="p">,</span>
<span class="lineno"> 5</span>   paste<span class="p">(</span>which<span class="p">(</span>is.na<span class="p">(</span>x<span class="o">$</span>enroll.date<span class="p">)),</span> collapse<span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
<span class="lineno"> 6</span> errors<span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="o">&lt;-</span> sprintf<span class="p">(</span><span class="s">&quot;no surgery date for rows [%s]&quot;</span><span class="p">,</span>
<span class="lineno"> 7</span>   paste<span class="p">(</span>which<span class="p">(</span>is.na<span class="p">(</span>x<span class="o">$</span>surgery.date<span class="p">)),</span> collapse<span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
<span class="lineno"> 8</span> errors<span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="o">&lt;-</span> sprintf<span class="p">(</span><span class="s">&quot;no followup date for rows [%s]&quot;</span><span class="p">,</span>
<span class="lineno"> 9</span>   paste<span class="p">(</span>which<span class="p">(</span>is.na<span class="p">(</span>x<span class="o">$</span>followup.date<span class="p">)),</span> collapse<span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
<span class="lineno">10</span> errors<span class="p">[</span><span class="m">4</span><span class="p">]</span> <span class="o">&lt;-</span> sprintf<span class="p">(</span><span class="s">&quot;must be enrolled before surgery for rows [%s]&quot;</span><span class="p">,</span>
<span class="lineno">11</span>   paste<span class="p">(</span>which<span class="p">(</span>x<span class="o">$</span>enroll.date <span class="o">&gt;</span> x<span class="o">$</span>surgery.date<span class="p">),</span> collapse<span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
<span class="lineno">12</span> errors<span class="p">[</span><span class="m">5</span><span class="p">]</span> <span class="o">&lt;-</span> sprintf<span class="p">(</span><span class="s">&quot;surgery required before follow-up for rows [%s]&quot;</span><span class="p">,</span>
<span class="lineno">13</span>   paste<span class="p">(</span>which<span class="p">(</span>x<span class="o">$</span>surgery.date <span class="o">&gt;</span> x<span class="o">$</span>followup.date<span class="p">),</span> collapse<span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
<span class="lineno">14</span> errors<span class="p">[</span><span class="m">6</span><span class="p">]</span> <span class="o">&lt;-</span> sprintf<span class="p">(</span><span class="s">&quot;height is too short or tall for rows [%s]&quot;</span><span class="p">,</span>
<span class="lineno">15</span>   paste<span class="p">(</span>which<span class="p">(</span>x<span class="o">$</span>height <span class="o">&lt;</span> <span class="m">48</span> <span class="o">|</span> x<span class="o">$</span>height <span class="o">&gt;</span> <span class="m">84</span><span class="p">),</span> collapse<span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
<span class="lineno">16</span> errors<span class="p">[</span><span class="m">7</span><span class="p">]</span> <span class="o">&lt;-</span> sprintf<span class="p">(</span><span class="s">&quot;on insulin, but not diabetic [%s]&quot;</span><span class="p">,</span>
<span class="lineno">17</span>   paste<span class="p">(</span>which<span class="p">(</span>x<span class="o">$</span>on.insulin <span class="o">&amp;</span> <span class="o">!</span>x<span class="o">$</span>diabetes<span class="p">),</span> collapse<span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              16/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>data.frame approach</h2></header>
            
            
            <section><div class="highlight"><pre><span class="lineno"> 1</span> errorList <span class="o">&lt;-</span> c<span class="p">(</span>
<span class="lineno"> 2</span>   miss.enroll <span class="o">=</span> <span class="s">&#39;no enroll date&#39;</span><span class="p">,</span>
<span class="lineno"> 3</span>   miss.surgery <span class="o">=</span> <span class="s">&#39;no surgery date&#39;</span><span class="p">,</span>
<span class="lineno"> 4</span>   miss.followup <span class="o">=</span> <span class="s">&#39;no followup date&#39;</span><span class="p">,</span>
<span class="lineno"> 5</span>   late.enroll <span class="o">=</span> <span class="s">&#39;must be enrolled before surgery&#39;</span><span class="p">,</span>
<span class="lineno"> 6</span>   late.surgery <span class="o">=</span> <span class="s">&#39;must have surgery before follow-up&#39;</span><span class="p">,</span>
<span class="lineno"> 7</span>   bad.height <span class="o">=</span> <span class="s">&#39;height is too short or tall&#39;</span><span class="p">,</span>
<span class="lineno"> 8</span>   bad.insulin <span class="o">=</span> <span class="s">&#39;on insulin, but not diabetic&#39;</span>
<span class="lineno"> 9</span> <span class="p">)</span>
<span class="lineno">10</span> errors <span class="o">&lt;-</span> data.frame<span class="p">(</span>matrix<span class="p">(</span><span class="kc">NA</span><span class="p">,</span> nrow<span class="o">=</span>nrow<span class="p">(</span>x<span class="p">),</span> ncol<span class="o">=</span>length<span class="p">(</span>errorList<span class="p">)))</span>
<span class="lineno">11</span> names<span class="p">(</span>errors<span class="p">)</span> <span class="o">&lt;-</span> names<span class="p">(</span>errorList<span class="p">)</span>
<span class="lineno">12</span> <span class="c1"># DRY applies here</span>
<span class="lineno">13</span> errors<span class="o">$</span>miss.enroll <span class="o">&lt;-</span> is.na<span class="p">(</span>x<span class="o">$</span>enroll.date<span class="p">)</span>
<span class="lineno">14</span> errors<span class="o">$</span>miss.surgery <span class="o">&lt;-</span> is.na<span class="p">(</span>x<span class="o">$</span>surgery.date<span class="p">)</span>
<span class="lineno">15</span> errors<span class="o">$</span>miss.followup <span class="o">&lt;-</span> is.na<span class="p">(</span>x<span class="o">$</span>followup.date<span class="p">)</span>
<span class="lineno">16</span> errors<span class="o">$</span>late.enroll <span class="o">&lt;-</span> x<span class="o">$</span>enroll.date <span class="o">&gt;</span> x<span class="o">$</span>surgery.date
<span class="lineno">17</span> errors<span class="o">$</span>late.surgery <span class="o">&lt;-</span> x<span class="o">$</span>surgery.date <span class="o">&gt;</span> x<span class="o">$</span>followup.date
<span class="lineno">18</span> errors<span class="o">$</span>bad.height <span class="o">&lt;-</span> x<span class="o">$</span>height <span class="o">&lt;</span> <span class="m">48</span> <span class="o">|</span> x<span class="o">$</span>height <span class="o">&gt;</span> <span class="m">84</span>
<span class="lineno">19</span> errors<span class="o">$</span>bad.insulin <span class="o">&lt;-</span> x<span class="o">$</span>on.insulin <span class="o">&amp;</span> <span class="o">!</span>x<span class="o">$</span>diabetes
<span class="lineno">20</span> errorMsg <span class="o">&lt;-</span> lapply<span class="p">(</span>names<span class="p">(</span>which<span class="p">(</span>colSums<span class="p">(</span>errors<span class="p">,</span> na.rm<span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)),</span>
<span class="lineno">21</span>   FUN<span class="o">=</span><span class="kr">function</span><span class="p">(</span>i<span class="p">)</span> <span class="p">{</span>
<span class="lineno">22</span>     sprintf<span class="p">(</span><span class="s">&quot;%s for rows [%s]&quot;</span><span class="p">,</span>
<span class="lineno">23</span>       errorList<span class="p">[</span>i<span class="p">],</span> paste<span class="p">(</span>which<span class="p">(</span>errors<span class="p">[,</span>i<span class="p">]),</span> collapse<span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
<span class="lineno">24</span>     <span class="p">)</span>
<span class="lineno">25</span>   <span class="p">}</span>
<span class="lineno">26</span> <span class="p">)</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              17/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>Some things must be done one ID at a time</h2></header>
            
            
            <section><div class="highlight"><pre><span class="lineno"> 1</span> checkHospitalization <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 2</span>   errorL <span class="o">&lt;-</span> c<span class="p">(</span>
<span class="lineno"> 3</span>     bad.dose <span class="o">=</span> <span class="s">&#39;time between doses is too short&#39;</span><span class="p">,</span>
<span class="lineno"> 4</span>     bad.admit <span class="o">=</span> <span class="s">&#39;first dose given too early&#39;</span><span class="p">,</span>
<span class="lineno"> 5</span>     need.dose <span class="o">=</span> <span class="s">&#39;dose required but missing&#39;</span><span class="p">,</span>
<span class="lineno"> 6</span>     extra.dose <span class="o">=</span> <span class="s">&#39;dose given but not required&#39;</span>
<span class="lineno"> 7</span>   <span class="p">)</span>
<span class="lineno"> 8</span>   uids <span class="o">&lt;-</span> unique<span class="p">(</span>x<span class="o">$</span>id<span class="p">)</span>
<span class="lineno"> 9</span>   <span class="c1"># don&#39;t use subset</span>
<span class="lineno">10</span>   z <span class="o">&lt;-</span> lapply<span class="p">(</span>uids<span class="p">,</span> FUN<span class="o">=</span><span class="kr">function</span><span class="p">(</span>i<span class="p">)</span> <span class="p">{</span>
<span class="lineno">11</span>     checkHospitalizationById<span class="p">(</span>subset<span class="p">(</span>x<span class="p">,</span> id <span class="o">==</span> i<span class="p">),</span> errorL<span class="p">)</span>
<span class="lineno">12</span>   <span class="p">})</span>
<span class="lineno">13</span>   <span class="c1"># predefine list size, easier to debug</span>
<span class="lineno">14</span>   zz <span class="o">&lt;-</span> vector<span class="p">(</span><span class="s">&#39;list&#39;</span><span class="p">,</span> length<span class="p">(</span>uids<span class="p">))</span>
<span class="lineno">15</span>   <span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> seq_along<span class="p">(</span>uids<span class="p">))</span> <span class="p">{</span>
<span class="lineno">16</span>     zz<span class="p">[[</span>i<span class="p">]]</span> <span class="o">&lt;-</span> checkHospitalizationById<span class="p">(</span>x<span class="p">[</span>x<span class="o">$</span>id <span class="o">==</span> uids<span class="p">[</span>i<span class="p">],],</span> errorL<span class="p">)</span>
<span class="lineno">17</span>   <span class="p">}</span>
<span class="lineno">18</span>   zzz <span class="o">&lt;-</span> do.call<span class="p">(</span>rbind<span class="p">,</span> zz<span class="p">)</span>
<span class="lineno">19</span>   errorMsg <span class="o">&lt;-</span> lapply<span class="p">(</span>colnames<span class="p">(</span>zzz<span class="p">),</span> FUN<span class="o">=</span><span class="kr">function</span><span class="p">(</span>i<span class="p">)</span> <span class="p">{</span>
<span class="lineno">20</span>     badix <span class="o">&lt;-</span> which<span class="p">(</span>nchar<span class="p">(</span>zzz<span class="p">[,</span>i<span class="p">])</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)</span>
<span class="lineno">21</span>     <span class="kr">if</span><span class="p">(</span>length<span class="p">(</span>badix<span class="p">))</span> <span class="p">{</span>
<span class="lineno">22</span>       sprintf<span class="p">(</span><span class="s">&quot;%s for id [%s] at rows [%s]&quot;</span><span class="p">,</span>
<span class="lineno">23</span>         errorL<span class="p">[</span>i<span class="p">],</span> rownames<span class="p">(</span>zzz<span class="p">)[</span>badix<span class="p">],</span> zzz<span class="p">[</span>badix<span class="p">,</span>i<span class="p">]</span>
<span class="lineno">24</span>       <span class="p">)</span>
<span class="lineno">25</span>     <span class="p">}</span>
<span class="lineno">26</span>   <span class="p">})</span>
<span class="lineno">27</span>   errorMsg
<span class="lineno">28</span> <span class="p">}</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              18/19
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: examples.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h2>Putting it together</h2></header>
            
            
            <section><div class="highlight"><pre><span class="lineno">1</span> dem.errors <span class="o">&lt;-</span> checkDemographics<span class="p">(</span>dat<span class="p">)</span>
<span class="lineno">2</span> <span class="c1"># when testing, work on a smaller subset</span>
<span class="lineno">3</span> hosp.errors <span class="o">&lt;-</span> checkHospitalization<span class="p">(</span>alldat<span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">1000</span><span class="p">,])</span>
<span class="lineno">4</span> all.errors <span class="o">&lt;-</span> unlist<span class="p">(</span>c<span class="p">(</span>dem.errors<span class="p">,</span> hosp.errors<span class="p">))</span>
<span class="lineno">5</span> 
<span class="lineno">6</span> <span class="c1"># write out errors</span>
<span class="lineno">7</span> write<span class="p">(</span>all.errors<span class="p">,</span> file <span class="o">=</span> file.path<span class="p">(</span>work.dir<span class="p">,</span> <span class="s">&#39;validation_errors.txt&#39;</span><span class="p">))</span>
</pre></div>

<h3>Check out <a href="http://datatable.r-forge.r-project.org/">data.table</a> and <a href="https://github.com/hadley/dplyr">dplyr</a></h3></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="examples.md">examples.md</a>
            </aside>
            
            <aside class="page_number">
              19/19
            </aside>
          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>
      
      <tr id="toc-row-1">
        <th><a href="#slide1">The R Seminar</a></th>
        <td><a href="#slide1">1</a></td>
      </tr>
      
        
        <tr id="toc-row-2" class="sub">
          <th><a href="#slide2">Code Efficiency</a></th>
          <td><a href="#slide2">2</a></td>
        </tr>
        
        <tr id="toc-row-3" class="sub">
          <th><a href="#slide3">Key Concepts</a></th>
          <td><a href="#slide3">3</a></td>
        </tr>
        
        <tr id="toc-row-4" class="sub">
          <th><a href="#slide4">Starting Point</a></th>
          <td><a href="#slide4">4</a></td>
        </tr>
        
        <tr id="toc-row-5" class="sub">
          <th><a href="#slide5">Assign a new column</a></th>
          <td><a href="#slide5">5</a></td>
        </tr>
        
        <tr id="toc-row-6" class="sub">
          <th><a href="#slide6">Convert TRUE/FALSE to 1/0</a></th>
          <td><a href="#slide6">6</a></td>
        </tr>
        
        <tr id="toc-row-7" class="sub">
          <th><a href="#slide7">Converting strings to dates</a></th>
          <td><a href="#slide7">7</a></td>
        </tr>
        
        <tr id="toc-row-8" class="sub">
          <th><a href="#slide8">Converting strings to date-times</a></th>
          <td><a href="#slide8">8</a></td>
        </tr>
        
        <tr id="toc-row-9" class="sub">
          <th><a href="#slide9">Too many tests</a></th>
          <td><a href="#slide9">9</a></td>
        </tr>
        
        <tr id="toc-row-10" class="sub">
          <th><a href="#slide10">What about more complicated tests?</a></th>
          <td><a href="#slide10">10</a></td>
        </tr>
        
        <tr id="toc-row-11" class="sub">
          <th><a href="#slide11">Vectorized solution is best</a></th>
          <td><a href="#slide11">11</a></td>
        </tr>
        
        <tr id="toc-row-12" class="sub">
          <th><a href="#slide12">Merging datasets</a></th>
          <td><a href="#slide12">12</a></td>
        </tr>
        
        <tr id="toc-row-13" class="sub">
          <th><a href="#slide13">Intermediate data set</a></th>
          <td><a href="#slide13">13</a></td>
        </tr>
        
        <tr id="toc-row-14" class="sub">
          <th><a href="#slide14">Validation</a></th>
          <td><a href="#slide14">14</a></td>
        </tr>
        
        <tr id="toc-row-15" class="sub">
          <th><a href="#slide15">How not to validate</a></th>
          <td><a href="#slide15">15</a></td>
        </tr>
        
        <tr id="toc-row-16" class="sub">
          <th><a href="#slide16">Pre-define errors</a></th>
          <td><a href="#slide16">16</a></td>
        </tr>
        
        <tr id="toc-row-17" class="sub">
          <th><a href="#slide17">data.frame approach</a></th>
          <td><a href="#slide17">17</a></td>
        </tr>
        
        <tr id="toc-row-18" class="sub">
          <th><a href="#slide18">Some things must be done one ID at a time</a></th>
          <td><a href="#slide18">18</a></td>
        </tr>
        
        <tr id="toc-row-19" class="sub">
          <th><a href="#slide19">Putting it together</a></th>
          <td><a href="#slide19">19</a></td>
        </tr>
        
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Expos</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Full screen slides</th>
        <td>e</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide slide context</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
  </div>
  <script>main()</script>
</body>
</html>